
set.seed(3005)

# SETUP KEY VARIABLES
numberOfTrials <- 500
numberOfParticipants <- 30
conditionNames <- c('Easy','Hard')
meanFixDuration <- 120
sdFixDuration <- 30
meanSacAmplitude <- 2
sdSacAmplitude <- 0.1
eventNames <- c('DISPLAY_START','DISPLAY_CHANGE')
#eventTimeMeans <-c(100,250,750)
#eventTimeSDs <- c(0,0,50)

# CREATE BASE DATA TABLE
xDT <- data.table(expand.grid(
  RECORDING_SESSION_LABEL=seq(1:numberOfParticipants),
  TRIAL_INDEX=seq(1:numberOfTrials),
  CURRENT_FIX_INDEX=seq(1:20))
)[order(RECORDING_SESSION_LABEL, TRIAL_INDEX, CURRENT_FIX_INDEX)]

# SET CORRECT RESPONSES
xDT[TRIAL_INDEX %between% c(1,numberOfTrials/2),CORRECT_RESPONSE:=7,]
xDT[TRIAL_INDEX %between% c(1,numberOfTrials/2),TRIALTYPE_TEXT:='YES',]
xDT[TRIAL_INDEX %between% c(numberOfTrials/2,numberOfTrials),CORRECT_RESPONSE:=8,]
xDT[TRIAL_INDEX %between% c(numberOfTrials/2,numberOfTrials),TRIALTYPE_TEXT:='NO',]

# BASIC FIXATION INFORMATION
xDT[,CURRENT_FIX_DURATION:=runif(min = meanFixDuration - sdFixDuration, max= meanFixDuration + sdFixDuration, n = nrow(xDT)),]
xDT[,PREVIOUS_FIX_DURATION:=shift(CURRENT_FIX_DURATION,1),list(RECORDING_SESSION_LABEL,TRIAL_INDEX)]
xDT[CURRENT_FIX_INDEX==1,PREVIOUS_FIX_DURATION:=0,]
xDT[,CURRENT_FIX_START:=cumsum(PREVIOUS_FIX_DURATION),list(RECORDING_SESSION_LABEL,TRIAL_INDEX)]
xDT[,CURRENT_FIX_END:=CURRENT_FIX_START+CURRENT_FIX_DURATION,]

# BASIC SACCADE AMPLITUDE INFORMATION
xDT[,NEXT_SAC_AMPLITUDE:=rnorm(meanSacAmplitude,sdSacAmplitude, n=nrow(xDT)),]

# BUTTON PRESSES
xDT[,FIX_INDEX_BUTTON_PRESS:=sample(seq(from=5, to = 15, by =1),1),list(RECORDING_SESSION_LABEL,TRIAL_INDEX)]
xDT[,RESPONSE_BUTTON_PRESSED:=sample(seq(7,8),1),list(RECORDING_SESSION_LABEL,TRIAL_INDEX)]

xDT$CURRENT_FIX_BUTTON_0_PRESS <- '.'
xDT$CURRENT_FIX_BUTTON_1_PRESS <- '.'
xDT$CURRENT_FIX_BUTTON_2_PRESS <- '.'
xDT$CURRENT_FIX_BUTTON_3_PRESS <- '.'
xDT$CURRENT_FIX_BUTTON_4_PRESS <- '.'
xDT$CURRENT_FIX_BUTTON_5_PRESS <- '.'
xDT$CURRENT_FIX_BUTTON_6_PRESS <- '.'
xDT[CURRENT_FIX_INDEX==FIX_INDEX_BUTTON_PRESS & RESPONSE_BUTTON_PRESSED==7,
    CURRENT_FIX_BUTTON_7_PRESS:=sample(seq(from=CURRENT_FIX_START, to=CURRENT_FIX_END,by=1),1),
    list(RECORDING_SESSION_LABEL,TRIAL_INDEX)]
xDT[CURRENT_FIX_INDEX==FIX_INDEX_BUTTON_PRESS & RESPONSE_BUTTON_PRESSED==8,
    CURRENT_FIX_BUTTON_8_PRESS:=sample(seq(from=CURRENT_FIX_START, to=CURRENT_FIX_END,by=1),1),
    list(RECORDING_SESSION_LABEL,TRIAL_INDEX)]

xDT$CURRENT_FIX_BUTTON_7_PRESS <- as.character(xDT$CURRENT_FIX_BUTTON_7_PRESS)
xDT$CURRENT_FIX_BUTTON_8_PRESS <- as.character(xDT$CURRENT_FIX_BUTTON_8_PRESS)

xDT[is.na(CURRENT_FIX_BUTTON_7_PRESS)==T,CURRENT_FIX_BUTTON_7_PRESS:='.',]
xDT[is.na(CURRENT_FIX_BUTTON_8_PRESS)==T,CURRENT_FIX_BUTTON_8_PRESS:='.',]

# KEEP ONLY ACTUAL DATA
xDT <- xDT[CURRENT_FIX_INDEX<=FIX_INDEX_BUTTON_PRESS,,]

# NOW MAKE MESSAGE REPORT
mDT <- data.table(expand.grid(
  RECORDING_SESSION_LABEL=seq(1:numberOfParticipants),
  TRIAL_INDEX=seq(1:numberOfTrials),
  CURRENT_MSG_INDEX=seq(1),
  CURRENT_MSG_TEXT=eventNames)
)[order(RECORDING_SESSION_LABEL, TRIAL_INDEX, CURRENT_MSG_INDEX)]

mDT[,CURRENT_MSG_INDEX:=cumsum(CURRENT_MSG_INDEX),list(RECORDING_SESSION_LABEL,TRIAL_INDEX)]
mDT[CURRENT_MSG_TEXT=='DISPLAY_START',CURRENT_MSG_TIME:=25+sample(seq(1:10),1),
    list(RECORDING_SESSION_LABEL, TRIAL_INDEX)]
mDT[CURRENT_MSG_TEXT=='DISPLAY_CHANGE',CURRENT_MSG_TIME:=250+sample(seq(1:10),1),
    list(RECORDING_SESSION_LABEL, TRIAL_INDEX)]

bDT <- xDT[CURRENT_FIX_BUTTON_7_PRESS!='.' | CURRENT_FIX_BUTTON_8_PRESS!='.',
           list(CURRENT_MSG_TEXT='BUTTON_PRESS', CURRENT_MSG_INDEX=3),
    list(RECORDING_SESSION_LABEL,TRIAL_INDEX, 
         RESPONSE_BUTTON_PRESSED,CURRENT_FIX_BUTTON_7_PRESS,
         CURRENT_FIX_BUTTON_8_PRESS)]

bDT[RESPONSE_BUTTON_PRESSED==7,CURRENT_MSG_TIME:=CURRENT_FIX_BUTTON_7_PRESS,]
bDT[RESPONSE_BUTTON_PRESSED==8,CURRENT_MSG_TIME:=CURRENT_FIX_BUTTON_8_PRESS,]
bDT$RESPONSE_BUTTON_PRESSED<-NULL
bDT$CURRENT_FIX_BUTTON_7_PRESS<-NULL
bDT$CURRENT_FIX_BUTTON_8_PRESS<-NULL

# FINALISE MESSAGE REPORT
mDT <- data.table(rbind(mDT,bDT))[order(RECORDING_SESSION_LABEL, TRIAL_INDEX, CURRENT_MSG_INDEX)]

write.table(xDT, 'fixationreport.txt',row.names=F, sep='\t')
write.table(mDT, 'messagereport.txt',row.names=F, sep='\t')

fixationreport <- xDT
messagereport <- mDT

save(fixationreport, file = 'fixationreport.RData')
save(messagereport, file = 'messagereport.RData')
